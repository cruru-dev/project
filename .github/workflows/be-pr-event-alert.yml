name: BE/PM - PR Review Ïä¨Îûô ÏïåÎ¶º

on:
  workflow_dispatch:
  pull_request:
    types: [ review_requested, ready_for_review ]
    branches:
      - main
      - 'be/**'
      - 'be-**'

  pull_request_review:
    types: [ submitted ]
    branches:
      - main
      - 'be/**'
      - 'be-**'

env:
  Dobby-Kim: "BEÌåÄ ÎèÑÎπÑ"
  Chocochip101: "BEÌåÄ Ï¥àÏΩîÏπ©"
  xogns1514: "BEÌåÄ Îü¨Ïâ¨"
  cutehumanS2:  "BEÌåÄ ÎÉ•Ïù∏"
  HyungHoKim00: "BEÌåÄ Î™ÖÏò§"
  
jobs:
  find-slack-thread:
    name: Slack Thread ID Í≤ÄÏÉâ
    runs-on: ubuntu-latest
    steps:
      - name: Find Comment & Slack Thread ID
        uses: peter-evans/find-comment@v3
        id: thread-id
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-regex: '^\d{10}\.\d{6}$'
      - name: Set Slack Thread ID
        run: echo "slack-thread-ts=${{ steps.thread-id.outputs.comment-body }}" >> "$GITHUB_OUTPUT"
        id: set-thread-id
    outputs:
      SLACK_THREAD_ID: ${{ steps.set-thread-id.outputs.slack-thread-ts }}

  set-slack-thread-if-not-exist-create:
    name: Slack Thread ID ÎØ∏Ï°¥Ïû¨Ïãú Thread ÏÉùÏÑ± Î∞è ID Îì±Î°ù
    needs: find-slack-thread
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewer and sender variables
        if: ${{ !needs.find-slack-thread.outputs.SLACK_THREAD_ID }}
        id: set-vars
        run: |
          ASSIGNEE_LOGIN=${{ github.event.pull_request.assignee.login }}
          echo "ASSIGNEE_SLACK_ID=${ASSIGNEE_LOGIN@L}" >> ${GITHUB_ENV}
          echo "ASSIGNEE_NICKNAME=${{ env[github.event.pull_request.assignee.login] }}" >> $GITHUB_ENV

      - name: pr review ÏöîÏ≤≠ -> Î¶¨Î∑∞Ïñ¥ÏóêÍ≤å slack Î©òÏÖò ÏïåÎ¶º
        if: ${{ !needs.find-slack-thread.outputs.SLACK_THREAD_ID }}
        id: send-message
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéÅ (#${{ github.event.pull_request.number }}) Pull RequestÍ∞Ä Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§!",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "\n*ÏßÑÌñâÏûê:*\n${{ env.ASSIGNEE_NICKNAME }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*${{ github.event.pull_request.title }}*"
                  },
                  "accessory": {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "üëâüèª PR Î∞îÎ°úÍ∞ÄÍ∏∞ üëàüèª",
                      "emoji": true
                    },
                    "value": "Î∞îÎ°úÍ∞ÄÍ∏∞ ÎßÅÌÅ¨",
                    "url": "${{ github.event.pull_request.html_url }}",
                    "action_id": "button-action"
                  }
                },
                {
                  "type": "divider"
                }
              ],
              "icon_url": "${{ github.event.sender.avatar_url }}"
            }

        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      - name: Slack Thread IDÎ•º PR commentÏóê Îì±Î°ù
        if: ${{ !needs.find-slack-thread.outputs.SLACK_THREAD_ID }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ${{ steps.send-message.outputs.ts }}
      
      - name: ÏÉùÏÑ±ÎêòÍ±∞ÎÇò Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Slack Thread ID Ï†ÑÎã¨
        id: final-thread-id
        run: |
          if [ -n "${{ needs.find-slack-thread.outputs.SLACK_THREAD_ID }}" ]; then
            echo "slack-thread-ts=${{ needs.find-slack-thread.outputs.SLACK_THREAD_ID }}" >> "$GITHUB_OUTPUT"
          else
            echo "slack-thread-ts=${{ steps.send-message.outputs.ts }}" >> "$GITHUB_OUTPUT"
          fi
        
    outputs:
      SLACK_THREAD_ID: ${{ steps.final-thread-id.outputs.slack-thread-ts }}

  review-requested_requested:
    name: Slack ThreadÎ°ú Î¶¨Î∑∞ ÏöîÏ≤≠ Î©òÏÖò ÎåìÍ∏Ä ÏÉùÏÑ±
    needs: set-slack-thread-if-not-exist-create
    if: github.event.action == 'review_requested'
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewer and sender variables
        id: set-vars
        run: |
          SENDER_LOGIN=${{ github.event.sender.login }}
          echo "SENDER_SLACK_ID=${SENDER_LOGIN@L}" >> ${GITHUB_ENV}
          echo "SENDER_NICKNAME=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV
          REVIEWER_LOGIN=${{ github.event.requested_reviewer.login }}
          echo "REVIEWER_SLACK_ID=${REVIEWER_LOGIN@L}" >> ${GITHUB_ENV}
          echo "REVIEWER_NICKNAME=${{ env[github.event.requested_reviewer.login] }}" >> $GITHUB_ENV
          

      - name: pr review ÏöîÏ≤≠ -> Î¶¨Î∑∞Ïñ¥ÏóêÍ≤å slack Î©òÏÖò ÏïåÎ¶º
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ needs.set-slack-thread-if-not-exist-create.outputs.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ú® Î¶¨Î∑∞ ÏöîÏ≤≠ ‚ú®",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.SENDER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "‚û°Ô∏è <@${{ env.REVIEWER_SLACK_ID }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üí°*PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ö°Ô∏è PR Î∞îÎ°úÍ∞ÄÍ∏∞ ‚ö°Ô∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ],
              "icon_url": "${{ github.event.sender.avatar_url }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  review-submitted_alert:
    name: Slack ThreadÎ°ú Î¶¨Î∑∞ ÏôÑÎ£å Î©òÏÖò ÎåìÍ∏Ä ÏÉùÏÑ±
    needs: set-slack-thread-if-not-exist-create
    if:  ( github.event.review.state == 'CHANGES_REQUESTED' || github.event.review.state == 'COMMENTED' ) && github.event.sender.login != github.event.pull_request.assignee.login
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewer and reviewee variables
        id: set-vars
        run: |
          ASSIGNEE_LOGIN=${{ github.event.pull_request.assignee.login }}
          echo "ASSIGNEE_SLACK_ID=${ASSIGNEE_LOGIN@L}" >> ${GITHUB_ENV}
          echo "ASSIGNEE_NICKNAME=${{ env[github.event.pull_request.assignee.login] }}" >> $GITHUB_ENV
          REVIEWER_LOGIN=${{ github.event.sender.login }}
          echo "REVIEWER_SLACK_ID=${REVIEWER_LOGIN@L}" >> ${GITHUB_ENV} 
          echo "REVIEWER_NICKNAME=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV

      - name: pr Î¶¨Î∑∞ submit -> assigneeÏóêÍ≤å slack Î©òÏÖò ÏïåÎ¶º
        if: env.ASSIGNEE_SLACK_ID != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ needs.set-slack-thread-if-not-exist-create.outputs.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üî•Î¶¨Î∑∞ ÏôÑÎ£åüî•",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.REVIEWER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "‚û°Ô∏è <@${{ env.ASSIGNEE_SLACK_ID }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üí°*PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "‚öíÔ∏è Î∞õÏùÄ Î¶¨Î∑∞ ÌôïÏù∏ÌïòÍ∏∞ ‚öíÔ∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ],
              "icon_url": "${{ github.event.sender.avatar_url }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          
  pr-approved_alert:
    needs: set-slack-thread-if-not-exist-create
    if: github.event.review.state == 'APPROVED'
    runs-on: ubuntu-latest
    steps:

      - name: Set assignee variables
        id: set-vars
        run: |
          ASSIGNEE_LOGIN=${{ github.event.pull_request.assignee.login }}
          echo "ASSIGNEE_SLACK_ID=${ASSIGNEE_LOGIN@L}" >> ${GITHUB_ENV}
          echo "ASSIGNEE_NICKNAME=${{ env[github.event.pull_request.assignee.login] }}" >> $GITHUB_ENV
          REVIEWER_LOGIN=${{ github.event.sender.login }}
          echo "REVIEWER_SLACK_ID=${REVIEWER_LOGIN@L}" >> ${GITHUB_ENV} 
          echo "REVIEWER_NICKNAME=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV

      - name: pr reviewerÍ∞Ä Approve ÌïòÎ©¥ slack ÏïåÎ¶º Î≥¥ÎÉÑ
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ needs.set-slack-thread-if-not-exist-create.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üèÅ PR ÏäπÏù∏ üèÅ",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.REVIEWER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "<@${{ env.ASSIGNEE_SLACK_ID }}>Îãò! \nÎ¶¨Î∑∞Ïñ¥ÏóêÍ≤å ÏäπÏù∏ÏùÑ Î∞õÏïòÏñ¥Ïöî!"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üöÄ *PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üïπÔ∏è Merge ÌïòÎü¨ Í∞ÄÍ∏∞ üïπÔ∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ],
              "icon_url": "${{ github.event.sender.avatar_url }}"
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
